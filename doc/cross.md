# Cross Domain

私は Ruverta を実用的な ASIC 設計にも使えるようにしたいと考えています。そのうえで避けては通れないのがクロスドメインの問題です。Ruverta では ASIC におけるドメインという概念に対して、良い抽象化と API を提供したいと考えています。

まずはドメインに何があるか考えてみましょう。

## Domains as many as possible

### 1. 電源ドメイン（Power Domain）

電源ドメインとは、異なる電源電圧や電源制御が適用される回路のグループのことです。チップ内部で機能ブロックごとに電源を分けることで、低消費電力化やパワーマネジメントが可能になります。

- 常時オン（Always-On, AON）ドメイン：リセット制御、パワーマネージャなど常に動作が必要な回路。
- パワーゲーティングドメイン：アイドル時に電源をOFFにして消費電力を削減する領域。
- 電圧スケーリングドメイン：負荷に応じて電圧を可変し、性能と電力を最適化。

異なる電圧間では**レベルシフタ（Level Shifter）**が必要。
電源のON/OFF順序やアイソレーションセルによる信号遮断も考慮する。

### 2. クロックドメイン（Clock Domain）

クロックドメインとは、同一クロック信号で駆動される回路の集合です。ASICは複数のクロック源を持つことが多く、周波数や位相の異なる領域間でデータ同期を取る必要があります。

**代表的な例**

- CPUコア（高周波数クロック）
- ペリフェラル（低周波数クロック）
- 外部インターフェース（非同期クロック）

**設計上の注意点**

- 異なるクロックドメイン間では**CDC（Clock Domain Crossing）**対策が必須（同期フリップフロップやFIFOの挿入）。
- CDCの検証ツールでメタステーブルのリスクを解析する。

### 3. リセットドメイン（Reset Domain）

**概要**

リセットドメインは、同じリセット信号によって制御される回路の領域です。複数の機能ブロックが異なる条件で初期化される場合、リセットも分ける必要があります。

**目的と効果**

- 電源ON時の順序制御を容易にする。
- ブロックごとの独立した再起動（ソフトリセット）を可能にする。
- テストやデバッグを簡素化。

### 4. 電圧/周波数ドメイン（Voltage/Frequency Domain）

**概要**

パフォーマンスと消費電力の最適化のため、チップ内の一部を異なる電圧・周波数条件で動作させる領域です。これは**DVFS（Dynamic Voltage and Frequency Scaling）**と呼ばれ、SoCなどでよく使われます。

**例**

- 高性能CPUコア → 高電圧・高周波数
- センサ制御ロジック → 低電圧・低周波数

### 5. 機能ドメイン（Functional Domain）

**概要**

設計や検証を効率化するため、機能ごとに回路を論理的に分割した領域です。これは必ずしも電気的な分割ではありませんが、階層化・フロアプラン設計・検証で重要な概念です。

**例**

- CPUドメイン
- GPUドメイン
- メモリコントローラドメイン
- 通信インターフェースドメイン（PCIe, USBなど）

### 6. テストドメイン（Test Domain）

**概要**

製造後のチップの不良検出や動作確認のために、テスト専用の回路や信号を制御する領域です。設計段階からDFT（Design for Testability）を考慮し、通常動作とは独立したドメインとして扱います。

**代表例**

- **Scan ドメイン**：スキャンチェーン用のクロック・制御信号で動作。
- **BIST ドメイン**（Built-In Self-Test）：メモリやロジックの自己診断用ブロック。
- **JTAG / Boundary Scan**：チップ外部とのI/O検査専用ドメイン。

**設計上のポイント**

- 通常動作のクロックやリセットとは独立制御できるようにする。
- テスト時のみ有効な信号が他のドメインへ影響しないようアイソレーションが必要。

### 7. セキュリティドメイン（Security Domain）

**概要**

暗号処理、鍵管理、セキュアブートなど高いセキュリティ要件を持つ回路をまとめた領域です。一般領域から分離して扱うことで、攻撃や情報漏えいのリスクを低減します。

**具体例**

- **Secure Boot / TrustZone**：起動時に信頼性を担保する専用領域。
- **Crypto Block**：AESやRSAなど暗号処理専用のロジック群。
- **Secure Key Storage**：鍵や証明書の安全な格納領域。

**設計上のポイント**

- 通常の機能ドメインとはアクセス制御を分離する。
- セキュアとノンセキュア間の通信には専用バスまたはブリッジが必要。

### 8. デバッグドメイン（Debug Domain）

**概要**

チップ動作の解析・評価を行うためのデバッグ専用の回路群です。製品出荷後にも利用される場合があるため、独立した制御が求められます。

**主な機能**

- **トレースユニット**（Trace Unit）：命令や信号の履歴記録。
- **ハードウェアブレークポイント/ウォッチポイント**
- **オンチップデバッグインターフェース**（OCD, JTAGなど）

**設計上の注意点**

- デバッグアクセスが通常の動作へ影響しないようにバス隔離を行う。
- 製品出荷後はアクセス制限（ロック機構）を設けることが多い。

### 9. セーフティドメイン（Safety Domain）

**概要**

自動車・医療・産業機器など高信頼性が要求されるシステムでは、安全機能をまとめたセーフティドメインが設けられます。

**主な役割**

- 監視・冗長回路（例：ロックステップCPU、ECCメモリ）
- フェイルセーフ制御ロジック（異常時に安全状態へ移行）
- ウォッチドッグタイマー、フェイルディテクタ など

**設計上のポイント**

- 安全関連ブロックは他の領域と独立して検証・認証される必要がある（ISO 26262など）。
- セーフティドメイン同士の通信も厳格なプロトコルを用いる。

### 10. インターフェースドメイン（I/O Domain）

**概要**

I/Oパッド周辺の回路群は、内部ロジックとは異なる電圧・タイミング・ESD保護設計が必要なため、**独立した「I/Oドメイン」**として扱います。

**例**

- コアロジック：0.8V動作
- I/O：1.8V / 3.3V動作
  - この間にレベルシフタやパッドリングを配置

**設計上の注意点**

- I/Oとコアロジック間の信号整合性・電圧耐性を考慮。
- ESD保護設計もI/Oドメイン特有の要素。

## ドメインとは何だろうか？

VerilogのModuleはtopから木構造になっています。
Ruvertaはこの木構造を扱うことに特化しています。

ではドメインはこの木構造に対してどのように関係するのでしょうか？
ModuleビルダであるRuvertaはドメインをどのように扱うと筋が良いでしょうか？

### アプローチ：ドメインはLogicの属性である

ModuleのIOにドメインを属性として付与する方式。
イメージは以下の通り。

```
module<A,B>( // Module のドメイン属性
    input a @ A, // Domain A
    input b @ B, // Domain B
    output o @ A // Domain A
)
```
